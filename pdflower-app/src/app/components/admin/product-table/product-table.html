<mat-toolbar color="primary" class="admin-toolbar">
    <span>Quản Lý Sản Phẩm</span>
    <span class="toolbar-spacer"></span>
    <button mat-raised-button class="admin-add-btn"
          matTooltip="Sản phẩm mới"
          matTooltipPosition="below"
          (click)="openProductModal()">
        <mat-icon>add</mat-icon>
        <span class="add-btn-text">Sản phẩm mới</span>
    </button>
</mat-toolbar>

<div class="table-container responsive-table mat-elevation-z8">
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
  <table mat-table [dataSource]="dataSource" matSort>
    
    <!-- Image Preview Column: Clicking header resets sort -->
    <ng-container matColumnDef="imagePreview">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Mới nhất </th>
      <td mat-cell *matCellDef="let element">
        <img [src]="element.mainImageUrl" alt="{{ element.name }}" class="product-preview-img" />
      </td>
    </ng-container>

    <!-- Name Column -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Tên sản phẩm </th>
      <td mat-cell *matCellDef="let element"> {{ element.name }} </td>
    </ng-container>

    <!-- Price Column -->
    <ng-container matColumnDef="price">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Giá </th>
      <td mat-cell *matCellDef="let element"> {{ element.price | currency:'VND':'symbol':'1.0-0' }} </td>
    </ng-container>
    
    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Trạng thái </th>
      <td mat-cell *matCellDef="let element"> 
        <mat-icon [color]="element.isActive ? 'primary' : 'warn'"
                  [matTooltip]="element.isActive ? 'Hiển thị' : 'Ẩn'">
            {{ element.isActive ? 'visibility' : 'visibility_off' }}
        </mat-icon>
      </td>
    </ng-container>

    <!-- Actions Column (Not Sortable) -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef> Hành động </th>
      <td mat-cell *matCellDef="let element">
        <button mat-icon-button (click)="toggleActiveStatus(element)" 
                [matTooltip]="element.isActive ? 'Ẩn sản phẩm' : 'Hiển thị sản phẩm'">
          <mat-icon color="primary">{{ element.isActive ? 'toggle_on' : 'toggle_off' }}</mat-icon>
        </button>
        
        <button mat-icon-button color="accent" (click)="openProductModal(element)" matTooltip="Chỉnh sửa">
          <mat-icon>edit</mat-icon>
        </button>

        <button mat-icon-button color="warn" (click)="deleteProduct(element.id)" matTooltip="Xóa">
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <div class="pagination-container">
    <div class="total-count-footer" *ngIf="!isLoading && paginator && dataSource.data.length > 0">
      Đang hiển thị 
      <strong>{{ paginator.pageIndex * 20 + 1 }}</strong> – 
      <strong>{{ Math.min((paginator.pageIndex + 1) * 20, dataSource.data.length) }}</strong> 
      trong tổng số <strong>{{ dataSource.data.length }}</strong> sản phẩm
    </div>
    <!-- Material paginator handles the logic and arrow buttons -->
    <mat-paginator [pageSize]="20" hidePageSize showFirstLastButtons></mat-paginator>
    
    <!-- Custom numbered buttons -->
    <div class="page-numbers-row" *ngIf="paginator">
      <button mat-mini-fab 
              *ngFor="let p of [].constructor(Math.ceil(dataSource.data.length / 20)); let i = index"
              [class.active-page]="paginator.pageIndex === i"
              class="page-num-btn"
              (click)="goToPage(i)">
        {{ i + 1 }}
      </button>
    </div>
  </div>
</div>
