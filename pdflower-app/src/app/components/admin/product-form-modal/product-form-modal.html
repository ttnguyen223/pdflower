<!-- HEADER SECTION: Centered title with boxed Close Button -->
<div class="dialog-header">
  <h2 mat-dialog-title>
    {{ data ? 'Chỉnh Sửa Sản Phẩm' : 'Sản Phẩm Mới' }}
  </h2>
  
  <button mat-icon-button class="close-box-btn" (click)="onCancel()" aria-label="Đóng">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- ERROR BANNER -->
@if (errorMessage) {
<div class="error-message-banner">
  <mat-icon color="warn">error</mat-icon>
  <span>{{ errorMessage }}</span>
</div>
}

<mat-dialog-content class="product-dialog-content">
  <form [formGroup]="form" class="product-form-modal">
    
    <!-- SECTION 1: Image Management -->
    <div class="form-section image-management-section">
        
        <!-- Existing Uploaded Previews -->
        <div class="image-previews-container">
          @for (image of sortedImagePreviews; track trackByIndex($index)) {
              <div class="preview-item-wrapper">
                  <mat-card class="preview-thumbnail-card" [class.main-image-border]="image.isMain">
                      <img [src]="image.url" alt="Product preview" class="preview-thumbnail-img" />
                      
                      <!-- Remove button visible on all images -->
                      <button mat-icon-button class="remove-local-file-button" 
                              (click)="removeImageUrlGroup($index); $event.stopPropagation()">
                          <mat-icon>close</mat-icon>
                      </button>
                  </mat-card>
                  
                  <!-- Label underneath, only for main image -->
                  @if (image.isMain) {
                      <span class="main-image-label">Chính</span>
                  }
              </div>
          }
      </div>

        <!-- Upload Interface -->
        <div class="upload-area-container">
            <div class="drop-zone" 
                 (dragover)="onDragOver($event)" 
                 (dragleave)="onDragLeave($event)" 
                 (drop)="onDrop($event)"
                 (click)="fileInput.click()">
                 
                 <mat-icon class="upload-icon">cloud_upload</mat-icon>
                 <p>Kéo và thả hình ảnh vào đây hoặc nhấp để chọn tệp</p>
                 <input type="file" multiple (change)="onFileSelected($event)" accept="image/*" #fileInput style="display: none;" />
            </div>

            <!-- Locally Selected Files -->
            @if (selectedFiles.length > 0) {
              <div class="upload-controls-bar">
                  <span class="file-count-label">Đã chọn: {{ selectedFiles.length }} tệp</span>
                  
                  <button mat-icon-button class="trash-clear-btn" (click)="clearSelectedFiles()" 
                          [disabled]="isUploading" matTooltip="Xóa danh sách">
                      <mat-icon>delete_outline</mat-icon>
                  </button>
              </div>

              <div class="local-previews-list">
                @for (previewUrl of localImagePreviews; track $index; let i = $index) {
                  <div class="local-preview-item">
                      <img [src]="previewUrl" alt="Local preview" class="preview-thumbnail-img" />
                      <button mat-icon-button class="remove-local-file-button" 
                              (click)="removeSelectedFile(i); $event.stopPropagation()">
                          <mat-icon>close</mat-icon>
                      </button>
                  </div>
                }
              </div>
            }
        </div>
    </div>

    <!-- SECTION 2: Product Details -->
    <div class="form-section details-section">      
      <!-- Cập nhật subscriptSizing="dynamic" để tránh chồng lấn lỗi -->
      <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
        <mat-label>Tên sản phẩm</mat-label>
        <input matInput formControlName="name" required />
        @if (form.controls['name'].invalid && form.controls['name'].touched) {
          <mat-error>Vui lòng nhập tên sản phẩm</mat-error>
        }
      </mat-form-field>

      <div class="price-quantity-group">
        <!-- Cập nhật subscriptSizing="dynamic" ở đây để đồng nhất khoảng cách -->
        <mat-form-field appearance="outline" class="price-input-field full-width" subscriptSizing="dynamic">
          <mat-label>Giá bán (₫)</mat-label>
          <input
            matInput
            type="text"
            formControlName="price"
            placeholder="0"
            required
            (input)="onPriceInput($event)"
          />
          @if (form.controls['price'].invalid && form.controls['price'].touched) {
            <mat-error>Vui lòng nhập giá tiền hợp lệ</mat-error>
          }
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width" subscriptSizing="dynamic">
        <mat-label>Mô tả (Tùy chọn)</mat-label>
        <textarea matInput formControlName="description" rows="4" placeholder="Nhập chi tiết về loại hoa, ý nghĩa..."></textarea>
      </mat-form-field>
    </div>

    <!-- SECTION 3: Categories -->
    <div class="form-section categories-section">
      <h4 class="section-title">Thể loại:</h4>
      <div class="category-grid">
        @for (category of categories$ | async; track category.id) {
          <div class="category-item">
            <mat-checkbox
              color="primary"
              [value]="category.name"
              (change)="onCategoryChange($event)"
              [checked]="categoriesFormArray.value.includes(category.name)"
            >
              {{ category.name }}
            </mat-checkbox>
          </div>
        } 
      </div>
      @if (categoriesFormArray.invalid && categoriesFormArray.touched) {
        <mat-error class="category-error">Vui lòng chọn ít nhất một danh mục.</mat-error>
      }
    </div>
  </form>
</mat-dialog-content>

<!-- ACTIONS FOOTER -->
<div class="dialog-actions-footer">
  <button mat-button class="cancel-btn"
    (click)="onCancel()"
    [disabled]="isUploading">Hủy bỏ
  </button>
  <button 
    mat-raised-button 
    class="save-btn"
    [disabled]="!form.valid || isUploading" 
    (click)="onSave()">
    {{ isUploading ? 'Đang lưu...' : 'Lưu sản phẩm' }}
  </button>
</div>
